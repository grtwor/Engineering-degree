<!DOCTYPE html>

<?php
	session_start();
	if(!isset($_SESSION['login']) or ($_SESSION['type'] != "user")){
            header('Location:dashboard');
		    exit();
	}
    elseif($_SESSION['type'] == "user"){
        if($_SESSION['userpass'] == "NO")
        {
             header('Location:index_');  
             exit();
		}
		elseif(strpos($_SESSION["lab"] , 'csrf') === false) {
			header('Location:home');
		    exit();
		}
    }
?>
<html>
	<head>
		<title>Settings</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">	
	</head>
		
	<body class="" style="background-image: url('img/bg_test.png'); background-repeat: auto; background-size: 1920px 1080px;">
		<div class="container-fluid">
			<div class="row">
				<div class="col-sm-3">
					<?php require_once("nav.php"); ?>
				</div>
				
				<div class="col-sm-6" >
					<div class="row">
						<h4 style="color: #d1ff52;  margin-top:1%;">Exploit Loader</h4>
					</div>


					<?php
					error_reporting(0);
					ini_set('display_errors', 0);
					if(strpos($_SESSION["lab"] , 'csrf') !== false) {
						$file = fopen("courses/csrf_exploit.html", "r") or die("Unable to open file 1!");
						
						

						echo '

					<div class="card " style="background: rgba(134,142,150,0.6);" > 
						<div class="card-body " style="padding-bottom:10%; padding-top:5%;">
							<form method="POST" action="exploitloader">
								<div class="form-group" style="color: #d1ff52;">
									<label for="exampleFormControlTextarea1">Request Head</label>
									<textarea class="form-control" id="exampleFormControlTextarea1" rows="3">
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
									</textarea>
								</div>
								<div class="form-group">
									<label for="exampleFormControlTextarea1" style="color: #d1ff52;" >Request Body</label>
									<textarea class="form-control" id="TABody" name="bodyarea" rows="10">'.fread($file,filesize("courses/csrf_exploit.html")).'
									</textarea>
								</div>
								<button type="submit" style="background-color:#b1de35; color:#2b2b2b; margin-top:1%; margin-left:2%;" class="btn button form_buttons float-left" name="Deliver"><i class="fas fa-sign-in-alt"></i> Deliver exploit </button>
							</form>

						</div>';
						fclose($file);

					}
					?>
						<?php
						error_reporting(0);
						ini_set('display_errors', 0);
							$server='localhost';
							$user='root';
							$password='P@rtyboy1.';
							$baza='labdb_csrf';
							$connect = mysqli_connect($server, $user, $password, $baza);


							$sql = "SELECT email from users WHERE login = 'franek';";
							$query = mysqli_query($connect, $sql);
							
							$row = mysqli_fetch_array($query);
							$emailoriginal= $row['email']; 
							$_SESSION['csrf_email'] = $emailoriginal;
							
							

							if(isset($_POST["Deliver"]) && ($_SESSION['csrf'] == "logged"))
							{

								$myfile = fopen("courses/csrf_exploit.html", "w") or die("Unable to open file!");
								$txt = $_POST['bodyarea'];
								fwrite($myfile, $txt);
								fclose($myfile);
								$_SESSION['exploit_delivered'] = "Delivered";
								echo"<script type='text/javascript'>
								//Place as last thing before the closing </body> tag
								if(location.search.indexOf('r') < 0){
								var hash = window.location.hash;
								var loc = window.location.href.replace(hash, '');
								loc += (loc.indexOf('?') < 0? '?' : '&') + 'r';
								// SET THE ONE TIME AUTOMATIC PAGE RELOAD TIME TO 5000 MILISECONDS (5 SECONDS):
								setTimeout(function(){window.location.href = loc + hash;}, 1);
								}
								</script>";	
								

							}	
						?>
						<?php
							error_reporting(0);
							ini_set('display_errors', 0);

							if($_SESSION['exploit_delivered'] == "Delivered"){
								$file = fopen("courses/csrf_exploit.html", "r") or die("Unable to open file!");
								echo'<p class="d-none"> '.fread($file,filesize("courses/csrf_exploit.html")).'</p>';
								fclose($file);
							}

							
						?>
					</div>
					

				</div>
			</div>

		</div>
		<div class="fixed-bottom container-fluid" style="margin:auto;">
            <?php 
                require_once("footer.php"); 
            ?>
        </div>
	</body>

</html>